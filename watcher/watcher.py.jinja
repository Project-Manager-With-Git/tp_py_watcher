import os
import time
from hashlib import md5
from typing import Dict, Any, Union
from watchdog.observers import Observer
# from watchdog.observers.polling import PollingObserver as Observer # 如果在docker中部署可以用PollingObserver
from watchdog.events import FileSystemEventHandler, DirModifiedEvent, FileModifiedEvent
from pyloggerhelper import log
from handler import EventHanddler


def watch(watch_path: str) -> None:
    """监控文件系统的函数.

    可以直接作为监控程序使用,注意需要先初始化log.
    
    """
    observer = Observer()
    handler = EventHanddler()
    observer.schedule(handler, watch_path, recursive=True)
    log.info('FSEvent Watching, Press Ctrl+{0} to exit'.format('Break' if os.name == 'nt' else 'C'))
    observer.start()
    try:
        while True:
            time.sleep(1)
    except (KeyboardInterrupt, SystemExit):
        log.info('crontab task stoped')
    except Exception as e:
        log.error("crontab task get error", err=type(e), err_msg=str(e), exc_info=True, stack_info=True)
    finally:
        observer.stop()
        observer.join()
